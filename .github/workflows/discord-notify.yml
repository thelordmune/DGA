name: Discord Push Notification

on:
  push:
    branches: [ main, master ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - name: Send Discord Notification
      run: |
        DISCORD_WEBHOOK="https://discordapp.com/api/webhooks/1419064748238180423/rQzkMO5ZErFf5YfZbnspMth8uxWm2rZEsY7U2pd6dTop-yn7zXExeVxO-wWAT7wXUiA0"

        # Get the commit message
        COMMIT_MSG='${{ github.event.head_commit.message }}'

        # Replace (line) markers with a special character first, then convert to newlines
        COMMIT_MSG=$(echo "$COMMIT_MSG" | sed 's/(line)/ยง/g')
        COMMIT_MSG=$(echo "$COMMIT_MSG" | tr 'ยง' '\n')

        # Extract first line (summary) and rest (description)
        SUMMARY=$(echo "$COMMIT_MSG" | head -n1)
        DESCRIPTION=$(echo "$COMMIT_MSG" | tail -n +2)

        # Remove leading empty lines from description
        DESCRIPTION=$(echo "$DESCRIPTION" | sed '/./,$!d')

        # Create the formatted message
        if [ -n "$DESCRIPTION" ]; then
          FORMATTED_MSG="**${SUMMARY}**"$'\n'"${DESCRIPTION}"
        else
          FORMATTED_MSG="**${SUMMARY}**"
        fi

        # Escape quotes and backslashes for JSON
        ESCAPED_MSG=$(echo "$FORMATTED_MSG" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')

        # Create JSON payload
        echo "{\"content\": \"$ESCAPED_MSG\"}" > payload.json

        # Send the webhook
        curl -H "Content-Type: application/json" \
             -X POST \
             -d @payload.json \
             "$DISCORD_WEBHOOK"
