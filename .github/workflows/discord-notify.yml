name: Discord Push Notification

on:
  push:
    branches: [ main, master ]
  workflow_call:
    secrets:
      DISCORD_WEBHOOK:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Get commit info
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          COMMIT_DESCRIPTION=$(git log -1 --pretty=format:"%b")
          AUTHOR=$(git log -1 --pretty=format:"%an")
          REPO_NAME="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"

          # Get lines added/removed
          DIFF_STATS=$(git diff --numstat HEAD~1 HEAD | awk '{added+=$1; removed+=$2} END {printf "ðŸŸ¢ +%d lines | ðŸ”´ -%d lines", added, removed}')

          # Create the JSON payload using jq for proper JSON formatting
          JSON_DATA=$(jq -n \
            --arg branch "$BRANCH" \
            --arg title "$COMMIT_MESSAGE" \
            --arg desc "$COMMIT_DESCRIPTION" \
            --arg footer "$DIFF_STATS" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            '{
              "embeds": [{
                "title": $title,
                "description": $desc,
                "color": 5814783,
                "timestamp": $timestamp,
                "footer": {
                  "text": $footer
                }
              }]
            }')

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_DATA" \
               "$DISCORD_WEBHOOK"
